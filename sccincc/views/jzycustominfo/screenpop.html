<script type="text/javascript"><!--
    $().ready(function () {

    });

        $(document).ready(function() 
          {
              //$('#Tip').hide();//显示操作提示的元素不可见
              $('#form1').submit(function()//提交表单
              {
                  //alert("ddd");
                  var cdid=$("#cdid").val();
                  var content=$("#content").val();
                  if(content=="" || /^\s+\s$/.test(content)){
                    alert("通话内容不能为空！");
                    return false;
                  }
                  var cardnumber=$("#Card_id").val();
                  if(cardnumber=="" || /^\s+\s$/.test(cardnumber)){
                      alert("会员卡号不能为空!");
                      return false;
                  }
                  var url="/jzy/screenPopInsert";
                  if(cdid!="")
                    url="/jzy/screenPopUpdate";
                  var options = { 
                //  target:'#Tip', //后台将把传递过来的值赋给该元素
                  url:url, //提交给哪个执行
                  type:'POST', 
                  success: function(result,status){
                      if(result.Code!=-1)
                      {
                      //$("#savesuccess").click();
                      var Card_id=$("#Card_id").val();
                     // $("#Card_id").attr("readonly","readonly");
                      $("#cdid").val(Card_id);
                      $("#thjlstatus").val(1);
                      alert(result.Message);
                      //$("#id").val(result.id);
                      }
                      else
                      //$("#saveerror").click();
                       alert(result.Message);
                      } //显示操作提示
                  }; 
                  $('#form1').ajaxSubmit(options); 
                  return false; //为了不刷新页面,返回false，反正都已经在后台执行完了，没事！                
              });

            $('#submit').click(function(){
               // alert(11);
                $('#form1').submit();
                });  
          }
       );
  
   
    function startfaq(id) {
       
        parent.myLib.desktop.win.newWin({
            WindowTitle: '知识库',
            iframSrc: '/Faq?faqCodeId='+id,
            WindowsId: "_知识库",
            WindowAnimation: 'none',
            WindowWidth: 960,
            WindowHeight: 540
        });
    }
    
    function historyzx() {
        var customid = $("#cdid").val();
        if (customid == "") {
            alert("请先保存来电者信息！");
            return false;
        }
        parent.myLib.desktop.win.newWin({
            WindowTitle: '历史来电',
            iframSrc: '/jzy/listThjl?Card_id=' + customid,
            WindowsId: customid+"_历史来电",
            WindowAnimation: 'none',
            WindowWidth: 960,
            WindowHeight: 540
        });

 

    }

    function historyyy() {
        var customid = $("#cdid").val();
        if (customid == "") {
            alert("请先保存来电者信息！");
            return false;
        }
        parent.myLib.desktop.win.newWin({
            WindowTitle: '商品档案',
            iframSrc: '/jzy/ygshop?Card_id='+customid,
            WindowsId: customid + "_商品档案",
            WindowAnimation: 'none',
            WindowWidth: 960,
            WindowHeight: 540
        });

    }



    function addconsult(){
        var customid = $("#cdid").val();
        var vipname=$('#Vip_name').val();
        if (customid == "") {
            alert("请先保存来电者信息！");
            return false;
        }
        parent.myLib.desktop.win.newWin({
            WindowTitle: '新增来电：<%= callmsg.caller%>的通话记录',
            iframSrc: '/jzy/createThjl?unid=<%= callmsg.unid%>&customid=' + customid+'&vipname='+vipname,
            WindowsId: "通话记录_<%= callmsg.unid%>",
            WindowAnimation: 'none',
            WindowWidth: 960,
            WindowHeight: 540
        });
    }
   
   function  play() {
    var unid=$('#unid').val();
    var filename='/SoundPlayer?filename='+unid;
    $("#playerframeid").attr("src", filename);
    $("#showplayer").modal("show");       
    }

</script>

<div class="row-fluid sortable">
<div class="box span12">
<div class="box-content"><a href="javascript:historyzx();"
	class="btn btn-small btn-primary"> <i class=" icon-edit icon-white"></i>历史来电</a>
<a href="javascript:historyyy();" role="button"
	class="btn btn-small btn-primary"> <i class="icon-tasks icon-white"></i>已购商品</a>
<a href="javascript:play();" class="btn btn-small btn-warning">
            <i class="icon-music icon-white"></i>播放录音</a>           
</div>
</div>
</div>
<div class="row-fluid sortable">

<form class="form-horizontal" method="post" id="form1" name="form1">
<div class="box-content span12">
  <div class="span4"><span style="font-weight:bold;">基本信息</span></div>
  <div class="span6"></div>
  <div class="span2">
  <button type="button" class="btn btn-primary" id="addyy" name="addyy" onclick="javascript:addyy2();">已有档案</button>
  </div>
  <input type="hidden"  id="unid" name="unid" value="<%= callmsg.unid%>" />
</div>

<div class="span12">
<div class="box-content span5">
<div class="control-group"> <label class="control-label" for="Vip_name">单位名称 </label>
<div class="controls"><input type="text" class="span12" id="Vip_name" name="Vip_name" value="<% if(inst!=null && typeof(inst.vip_name)!=='object'){%><%=inst.vip_name %><% }else{%><%}%>" /></div>
</div>
<div class="control-group"> <label class="control-label"
	for="Vip_sex">性别 </label>
<div class="controls">
<select id="Vip_sex" name="Vip_sex">
    <option value="男"  <%if(inst!=null && typeof(inst.vip_sex)!=='object' && inst.vip_sex == '男'){%>
        selected="selected"<%}%>>男</option>  
     <option value="女"  <%if(inst!=null && typeof(inst.vip_sex)!=='object' && inst.vip_sex == '女'){%>
        selected="selected"<%}%>>女</option>
</select>
</div>
</div>
<div class="control-group"> <label class="control-label"
	for="Company">其他 </label>
<div class="controls"><input type="text" class="span12"
	id="Company" name="Company" value="<% if(inst!=null && typeof(inst.company)!=='object'){%><%= inst.company%><%}%>" /> </div>
</div>

<div class="control-group"> <label class="control-label"
    for="Vip_tel">联系电话一</label>
<div class="controls"><input type="text" class="span12" id="Vip_tel"
    name="Vip_tel" value="<% if(inst!=null && typeof(inst.vip_tel)!=='object'){%><%= inst.vip_tel%><%}else{%><%= phone%><%}%>" /> 
<input type="hidden" name="phone" id="phone" value="<%= phone%>" />
  </div>
</div>

<div class="control-group"> <label class="control-label"
    for="Mobile">联系电话二</label>
<div class="controls"><input type="text" class="span12" id="Mobile"
    name="Mobile" value="<% if(inst!=null && typeof(inst.mobile)!=='object'){%><%= inst.mobile%><%}%>" /> </div>
</div>

</div>
<div class="box-content span5">
<div class="control-group"> <label class="control-label" for="Card_id">会员卡号</label>
<div class="controls"><input type="text" class="span12" id="Card_id"
    name="Card_id" value="<%if(inst!=null && typeof(inst.card_id)!=='object'){%><%= inst.card_id%><%}%>" /> </div>
<input type="hidden" id="cdid" name="cdid" value="<%if(inst!=null && typeof(inst.card_id)!=='object'){%><%= inst.card_id%><%}%>"/>
</div>



<div class="control-group"> <label class="control-label" for="Card_type">卡类型
</label>
<div class="controls">
<select id="Card_type" name="Card_type">
  <%for(var iii=0;iii<cardtype2.length;iii++){
    var tmp=cardtype2[iii].type_id.replace(/\s+/g,"");
    %>
  <option value=<%= tmp%>><%= cardtype2[iii].type_name%></option> 
  <%}%>

</select>
</div>
</div>

<div class="control-group"> <label class="control-label" for="Discount">折扣
</label>
<div class="controls"><input type="text" class="span12" readonly="readonly" id="Discount"
    name="Discount" value="<% if(inst!=null && typeof(inst.discount)!=='object'){%><%= inst.discount%><%}%>" /> </div>
</div>

<div class="control-group"> <label class="control-label"
    for="Vip_add">联系地址</label>
<div class="controls"><input type="text" class="span12" id="Vip_add"
    name="Vip_add" value="<% if(inst!=null && typeof(inst.vip_add)!=='object'){%><%= inst.vip_add%><%}%>" /> </div>
</div>


<div class="control-group"> <label class="control-label"
    for="Jbr">经办人 </label>
<div class="controls"><input type="text" class="span12 autogrow" id="Jbr"
 name="Jbr" value="<% if(inst!=null && typeof(inst.social_id)!=='object'){%><%= inst.social_id%><%}%>" />
</div>
</div>

</div>
</div>
<div class="box-header well" data-original-title>
<span style="font-weight:bold;">最近通话记录</span>
<div class="box-icon"><a href="#"
  class="btn btn-minimize btn-round"><i class="icon-chevron-up"></i></a>
</div>
</div>
<div class="box-content">
<table class="table table-striped table-bordered bootstrap-datatable datatable">
  <thead>
    <tr>
       
      <th width="20%">记录时间</th>        
      <th width="30%">通话类容</th>
      <th width="20%">处理状态</th>
      <th width="30%">处理内容</th>      
    </tr>
  </thead>
  <tbody id="lsthjl3">
  </tbody>

  </table>
</div>

<div class="box-content span12">
  <div class="span4"><span style="font-weight:bold;">通话记录</span></div>
  <div class="span6"></div>
  <div class="span2">
  </div>

</div>
 
<div class="box-content span12">
<div class="box-content span5">
              <div class="control-group"> 
              <label class="control-label" for="content">通话内容</label> 
              <div class="controls"> 
              <textarea  id="content" name="content"></textarea>
              
                                           </div> 
              </div> 
              <div class="control-group"> 
              <label class="control-label" for="donesth">处理内容</label> 
              <div class="controls"> 
              <textarea  id="donesth" name="donesth"></textarea>
              </div> 
              </div> 

             
            </div>
<div class="box-content span5">
            
             <div class="control-group"> 
              <label class="control-label" for="dostate">处理状态 </label> 
              <div class="controls"> 
              <select id="dostate" name="dostate">
              <option value='0'>未处理</option>
              <option value='1'>处理中</option>
              <option value='2'>已处理</option>
              </select> 
              <input type="hidden" name="thjlstatus" id="thjlstatus" value="0" />
               </div> 
              </div> 

              <div class="form-actions">
<button type="button" class="btn btn-primary" id="submit" name="submit">保存</button>
</div>
            </div>
              
</div>

</form>
<div style="display: none">
<button id="savesuccess" name="savesuccess" class="btn btn-primary noty"
	data-noty-options='{"text":"保存成功！","layout":"topCenter","type":"success","animateOpen": {"opacity": "show"}}'>
<i class="icon-bell icon-white"></i> Top Center (fade)</button>
<button id="saveerror" name="saveerrir" class="btn btn-primary noty"
	data-noty-options='{"text":"保存失败！","layout":"topCenter","type":"error"}'><i
	class="icon-bell icon-white"></i> Top Right</button>
</div>
</div>
  <!--
<div class="box-content">
  <a href="javascript:addconsult();"
	class="btn btn-small btn-primary"> <i class="icon-edit icon-white"></i>新建来电</a>
  
<a href="javascript:addorder();" role="button"
	class="btn btn-small btn-primary" data-toggle="modal"> <i
	class="icon-tasks icon-white"></i>新建工单</a> <a href="javascript:addts();"
	role="button" class="btn btn-small btn-primary" data-toggle="modal">
<i class="icon-leaf icon-white"></i>投诉建议</a>

</div>
-->
</div>
</div>




<div id="mysearch" class="modal hide fade" tabindex="-1" role="dialog"
    aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
</div>
<div class="modal-body">
<div class="row-fluid sortable">
<div class="box span12">
<div class="box-content">
<h3>符合条件的客户档案列表</h3>
<table id='selectcustom'> 
</table>
</div>
</div>
</div>
</div>

</div>


<script type="text/javascript">
$(function(){
var carddddd=4;
<%if(inst!=null && typeof(inst.card_type)!=='object'){%>
  carddddd=<%= inst.card_type%>;
<%}%>
$("#Card_type").find("option[value="+carddddd+"]").attr("selected","selected");
$("#Card_type").change(function(event) {
  var dicot=<%= cardtype%>;
 var test=$("#Card_type").val();
/*for(var key in dicot){
  if(key=="id_0")
     alert(dicot[key]);
  alert(key);
 
}*/
 $("#Discount").val(dicot["id_"+test]);
 addoldrecord();
});

//lsthjl3
addoldrecord();


});


function addoldrecord(){
var CardId=$('#Card_id').val()==""?"-99999":$('#Card_id').val();
var where='Card_id='+CardId;
    where+='&iDisplayStart=0&iDisplayLength=3';
   $.ajax(
              {
                  url: '/jzy/getCalls?'+where,
                  dataType: 'json',
                  type: 'GET',
                  async: false,
                  data:{},
                  success: function (data, textStatus) {                      
                  if(data && data.aaData.length>0){
                    var html="";
                    for(var ii=0;ii<data.aaData.length;ii++){
html+="<tr>";
html+="<td>"+data.aaData[ii].recordtime+"</td>";
html+="<td>"+data.aaData[ii].content+"</td>";
var tmmmp="未处理";
if(data.aaData[ii].dostate=="1")
  tmmmp="处理中";
if(data.aaData[ii].dostate=="2")
  tmmmp="已完成";

html+="<td>"+tmmmp+"</td>";
html+="<td>"+data.aaData[ii].donesth+"</td>";
html+="</tr>";

                    }
                    $("#lsthjl3").html(html);
                  }            
                  },
                  error: function (XMLHttpRequest, textStatus, errorThrown) {
                      alert('服务器访问发生异常！' + textStatus);
                      return;
                  }
              }
              );  
}

function addyy1(){
    alert(1);
}
function addyy2(){
var where='';
where+='Vip_name='+$('#Vip_name').val();
where+='&'+'Card_id'+$('#Card_id').val();
where+='&'+'Jbr'+$('#Jbr').val();
   $.ajax(
                {
                    url: '/jzy/getCustoms?'+where,
                    dataType: 'json',
                    type: 'POST',
                    async: false,
                   // data:{ids:ids},
                    success: function (data, textStatus) {                      
                            //alert(data.aaData);
                            if(typeof(data.aaData)==='object' && Object.prototype.toString.call(data.aaData) !== '[object Array]' &&　data.aaData!=null){
                                $("#selectcustom").html('');
                                var str="<tr><th>客户姓名</th><th>会员卡号</th><th>工作单位</th><th>操作</th></tr>";
                                //for(var iii in data.aaData){
                                    //alert(iii);
                                    str+="<tr>";
                                    str+="<td>"+data.aaData.vip_name+"</td>";
                                    str+="<td>"+data.aaData.card_id+"</td>";
                                    if(typeof(data.aaData.company)==='object'){
    str+="<td>————</td>";

}else{
str+="<td>"+data.aaData.company+"</td>";
}
   
                                    str+="<td><a href=javascript:setselect('"+data.aaData.card_id+"');>选择</a></td>";
                                     str+="</tr>"

                                if(data.aaData.vip_name==""){
                                  
                                }

                                //}
                                 $("#selectcustom").html(str); 
                                 $('#mysearch').modal('show');


                            }
                            else if(Object.prototype.toString.call(data.aaData) === '[object Array]') {
                                 $("#selectcustom").html('');
                                var str="<tr><th>客户姓名</th><th>会员卡号</th><th>工作单位</th><th>操作</th></tr>";
                                for(var i=0;i<data.aaData.length;i++){
                                    
                                    str+="<tr>";
                                    str+="<td>"+data.aaData[i].vip_name+"</td>";
                                    str+="<td>"+data.aaData[i].card_id+"</td>";
                                    if(typeof(data.aaData[i].company)==='object'){
    str+="<td>————</td>";

}else{
str+="<td>"+data.aaData[i].company+"</td>";
}
                                    
                                    str+="<td><a href=\"javascript:setselect('"+data.aaData[i].card_id+"');\">选择</a></td>";
                                     str+="</tr>";

                                if(i==data.aaData.length-1){
                                 $("#selectcustom").html(str); 
                                // alert(str);
                                 $('#mysearch').modal('show');
                                  
                                }

                                }
                                 

                            }
                            else{
                               alert("没有找到适合的客户档案。"); 
                            }                          
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert('服务器访问发生异常！' + textStatus);
                        return;
                    }
                }
                );    
}

function setselect(card_id){
 $.ajax(
                {
                    url: '/jzy/getCustomById',
                    dataType: 'json',
                    type: 'POST',
                    async: false,
                    data:{id:card_id},
                    success: function (data, textStatus) {  
                    if(data!=null) {
                        if(typeof(data.vip_name)==='object')
                            $('#Vip_name').val("");
                        else
                       $('#Vip_name').val(data.vip_name);
                   if(typeof(data.card_id)==='object')
                    $('#Card_id').val("");
else


                       $('#Card_id').val(data.card_id);

                   if(typeof(data.vip_sex)==='object')
                     $('#Vip_sex').val(""); 
                 else

                       $('#Vip_sex').val(data.vip_sex); 

                   if(typeof(data.social_id)==='object')
                    $('#Jbr').val(""); 
                    else
                       $('#Jbr').val(data.social_id); 

                   if(typeof(data.card_type)!=='object')
                   {
                     var tmptype=data.card_type.replace(/\s+/g,"");
                     //alert(tmptype);
                      $("#Card_type").find("option[value="+tmptype+"]").attr("selected","selected");

                     //$('#Card_type').val(tmptype);
                      var dicot=<%= cardtype%>;
 var test=$("#Card_type").val();
/*for(var key in dicot){
  if(key=="id_0")
     alert(dicot[key]);
  alert(key);
 
}*/
 $("#Discount").val(dicot["id_"+test]);

                   }
                      

                   if(typeof(data.company)==='object')
                     $('#Company').val("");
                    else
                       $('#Company').val(data.company);

                   $("#cdid").val(data.card_id);


                       $('#mysearch').modal('hide');


                    }
                    else{
                        alert("通过会员卡号重新绑定客户档案失败！");
                    }                   
                                                  
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert('服务器访问发生异常！' + textStatus);
                        return;
                    }
                }
                );   
}



</script>




<div id="showplayer" class="modal hide fade" tabindex="-1" role="dialog"
  aria-labelledby="myModalLabel" aria-hidden="true">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal"
  aria-hidden="true">×</button>
<h3 id="myModalLabel">录音播放</h3>
</div>
<div class="modal-body">
<div class="row-fluid sortable">
<div class="box span12">
<div class="box-content">
<iframe id="playerframeid"></iframe>
</div>
</div>
</div>
</div>

</div>